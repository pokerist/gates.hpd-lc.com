{% extends "base.html" %}
{% block content %}
<section class="card hero">
  <h2>Manual Debug (فحص يدوي)</h2>
  <p>رفع صورة أو التقاطها للمعاينة فقط.</p>
</section>

<section class="grid grid-2">
  <div class="card">
    <div class="camera-container">
      <video id="debugCamera" autoplay playsinline></video>
      <canvas id="debugCanvas" class="hidden" hidden></canvas>
      <div class="camera-frame">
        <div class="frame-box"></div>
      </div>
    </div>
    <div style="margin-top: 14px; display: flex; gap: 10px; flex-wrap: wrap;">
      <button class="btn btn-primary" id="debugCaptureBtn">التقاط</button>
      <button class="btn btn-secondary" id="debugSwitchBtn">تبديل الكاميرا</button>
      <label class="btn btn-outline">
        رفع صورة
        <input id="debugFileInput" type="file" accept="image/*" capture="environment" hidden />
      </label>
    </div>
  </div>

  <div class="card">
    <h3>صورة البطاقة المقصوصة</h3>
    <div style="margin-top: 12px;">
      <img id="debugImage" alt="debug" style="width:100%; border-radius: 14px; border: 1px solid rgba(255,255,255,0.1); display:none;" />
    </div>
    <div class="grid grid-2" style="margin-top: 16px;">
      <div>
        <h4 style="margin-bottom: 8px;">الصورة المُرسلة لـ Document AI</h4>
        <img id="debugDocaiImage" alt="docai" style="width:100%; border-radius: 14px; border: 1px solid rgba(255,255,255,0.1); display:none;" />
      </div>
      <div>
        <h4 style="margin-bottom: 8px;">صورة الوجه المستخرجة</h4>
        <img id="debugFaceImage" alt="face" style="width:100%; border-radius: 14px; border: 1px solid rgba(255,255,255,0.1); display:none;" />
      </div>
    </div>
    <div class="debug-accordion">
      <details class="accordion">
        <summary>النتيجة النهائية</summary>
        <div id="debugFinal" class="field-list"></div>
      </details>
      <details class="accordion">
        <summary>Tesseract</summary>
        <div id="debugTess" class="field-list"></div>
      </details>
      <details class="accordion">
        <summary>Document AI (كل الحقول)</summary>
        <div id="debugDocai" class="field-list"></div>
      </details>
      <details class="accordion">
        <summary>زمن التنفيذ</summary>
        <div id="debugTimings" class="field-list"></div>
      </details>
      <details class="accordion">
        <summary>الحقول المكتشفة</summary>
        <div id="debugFields" class="field-list"></div>
      </details>
    </div>
  </div>
</section>

<section class="card" style="margin-top: 18px;">
  <h3 style="margin-bottom: 8px;">الإعدادات</h3>
  <p style="margin-bottom: 18px; color: var(--muted);">تحكم سريع في إعدادات تحسين الأداء والدقة.</p>
  <div class="settings-list">
    <div class="settings-row">
      <div class="settings-meta">
        <h3>تحويل صورة Document AI لأبيض وأسود</h3>
        <p>يقلل حجم الصورة ويرفع سرعة المعالجة، مع الحفاظ على جودة النص.</p>
      </div>
      <label class="toggle">
        <input type="checkbox" id="docaiGrayscaleToggle" />
        <span class="slider"></span>
      </label>
    </div>
    <div class="settings-row">
      <div class="settings-meta">
        <h3>تفعيل مطابقة الوجه</h3>
        <p>يفحص صورة الوجه محلياً لتقليل تكلفة Document AI وتسريع القرار.</p>
      </div>
      <label class="toggle">
        <input type="checkbox" id="faceMatchToggle" />
        <span class="slider"></span>
      </label>
    </div>
    <div class="settings-row">
      <div class="settings-meta">
        <h3>قوة الشبه المطلوبة</h3>
        <p>كلما زادت القيمة، زادت الدقة وقلت المطابقات الخاطئة. المدى: 0.20 - 0.90</p>
      </div>
      <div class="range-control">
        <input type="number" id="faceMatchThreshold" min="0.2" max="0.9" step="0.01" />
        <span id="faceMatchThresholdValue">0.35</span>
      </div>
    </div>
    <div class="settings-row">
      <div class="settings-meta">
        <h3>أقصى بُعد للصورة المرسلة لـ Document AI</h3>
        <p>قيمة أقل تعني سرعة أعلى وتكلفة أقل. المدى: 640 - 3000</p>
      </div>
      <div class="range-control">
        <input type="number" id="docaiMaxDim" min="640" max="3000" step="10" />
        <span id="docaiMaxDimValue">1600</span>
      </div>
    </div>
    <div class="settings-row">
      <div class="settings-meta">
        <h3>جودة JPEG لـ Document AI</h3>
        <p>قيمة أقل تقلل الحجم، مع احتمال بسيط لتأثير الدقة. المدى: 50 - 95</p>
      </div>
      <div class="range-control">
        <input type="number" id="docaiJpegQuality" min="50" max="95" step="1" />
        <span id="docaiJpegQualityValue">85</span>
      </div>
    </div>
  </div>
  <div id="settingsStatus" class="settings-status"></div>
</section>
{% endblock %}

{% block scripts %}
<script src="/static/js/debug.js"></script>
<script src="/static/js/settings.js"></script>
{% endblock %}
